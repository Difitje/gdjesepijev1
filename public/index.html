<!DOCTYPE html>
<html lang="hr">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Gdje se pije? (beta) </title>
    <link rel="stylesheet" href="/style.css">
</head>
<body>
    <div class="container" id="intro">
        <h2>üçª Dosadno vam je?</h2>
        <p style="text-align:center;">Pridru≈æi se ekipi koja zna kako se loƒçe!</p>
        <button onclick="navigateTo('odabir')">Pridru≈æi se</button>
    </div>

    <div class="container" id="pravilaEkran">
        <div class="top-nav-buttons">
            <button class="back-button" onclick="navigateBack()">‚Üê</button>
        </div>
        <h2>Pravila kori≈°tenja</h2>
        <div class="pravila-text">
            <p>Dobrodo≈°li! Prije nego ≈°to nastavite, molimo vas da pa≈æljivo proƒçitate i prihvatite sljedeƒáa pravila:</p>
            <p><strong>1. Punoljetnost:</strong> Morate imati najmanje 18 godina da biste koristili ovu aplikaciju.</p>
            <p><strong>2. Po≈°tovanje:</strong> Pona≈°ajte se prema drugima s po≈°tovanjem. Bilo kakav oblik uznemiravanja, govora mr≈ænje ili nasilnog pona≈°anja nije dozvoljen i rezultirat ƒáe trajnom zabranom.</p>
            <p><strong>3. Sigurnost na prvom mjestu:</strong> Kada se sastajete s drugim korisnicima, ƒçinite to na javnim i sigurnim mjestima. Obavijestite prijatelja gdje idete. Budite odgovorni.</p>
            <p><strong>4. Zakonitost:</strong> Zabranjeno je organiziranje ili promoviranje bilo kakvih ilegalnih aktivnosti putem ove platforme.</p>
            <p><strong>Odricanje od odgovornosti:</strong> Ova aplikacija je samo platforma za povezivanje. Mi, kao kreatori, nismo odgovorni za pona≈°anje korisnika, niti za bilo kakve direktne ili indirektne posljedice, ≈°tete ili povrede koje mogu nastati kao rezultat kori≈°tenja aplikacije. Koristite je na vlastitu odgovornost.</p>
        </div>
        <div class="pravila-checkbox-wrapper">
            <input type="checkbox" id="prihvatamPravila" onchange="proveriPrihvatanje()">
            <label for="prihvatamPravila">Proƒçitao/la sam i prihvaƒáam pravila.</label>
        </div>
        <button id="nastaviBtn" onclick="navigateTo('registracija')" disabled>Prihvati i nastavi</button>
    </div>

    <div class="container" id="odabir">
        <h2>Dobrodo≈°li!</h2>
        <p style="text-align:center;">Ima≈° raƒçun? Prijavi se. Nema≈°? Registriraj se.</p>
        <button onclick="navigateTo('login')">Prijava</button>
        <button onclick="navigateTo('pravilaEkran')">Registracija</button>
    </div>

    <div class="container" id="login">
        <div class="top-nav-buttons">
            <button class="back-button" onclick="navigateBack()">‚Üê</button>
        </div>
        <h2>Prijava</h2>
        <input id="loginIme" placeholder="Korisniƒçko ime" />
        <input id="loginSifra" type="password" placeholder="Lozinka" />
        <button id="loginSubmitBtn" onclick="ulogujSe()">Prijavi se</button>
    </div>

    <div class="container" id="registracija">
        <div class="top-nav-buttons">
            <button class="back-button" onclick="navigateBack()">‚Üê</button>
        </div>
        <h2>Registracija</h2>
        <input id="ime" placeholder="Korisniƒçko ime" />
        <input id="sifra" type="password" placeholder="Lozinka" />
        <label style="font-size:14px; display:block; margin-bottom:5px;">Profilna slika:</label>
        <input type="file" id="slikaUpload" accept="image/*" />
        <img id="previewSlikes" class="preview-slika" /> <input id="instagram" placeholder="Instagram korisniƒçko ime (bez @)" />
        <input id="tiktok" placeholder="TikTok korisniƒçko ime (bez @)" />
        <textarea id="opis" placeholder="O meni..." rows="3"></textarea>
        <button id="registracijaSubmitBtn" onclick="registruj()">Spremi</button>
    </div>

    <div class="container" id="homePrazan">
        <div class="main-header">
            <h1 class="main-logo">
                <img src="/logo.png" alt="Tvoj logo" class="header-logo-image">
            </h1>
        </div>
        <p style="text-align:center; padding-top: 50px;">Ovo je tvoj Home feed!</p>
        </div>

    <div class="container" id="lokacijePrikaz">
        <div class="main-header">
            <h1 class="main-logo">
                <img src="/logo.png" alt="Tvoj logo" class="header-logo-image">
            </h1>
        </div>

        <h2>Trenutno pije:</h2> <div id="pijankePregled"></div>
    </div>

    <div class="container" id="inboxPrikaz">
        <div class="top-nav-buttons">
            <button class="back-button" onclick="navigateBack()">‚Üê</button>
        </div>
        <h2>Poruke</h2>
        <div id="listaChatova"></div>
    </div>

    <div class="container" id="glavniDio">
        <div class="top-nav-buttons">
            <button class="back-button" onclick="navigateBack()" style="display:none;">‚Üê</button>
            <button class="close-btn" onclick="navigateBack()" style="display:none;">‚úñ</button>
        </div>
        <h2 id="glavniNaslov"></h2>
        <div id="objavaForma">
            <textarea id="opisPijanke" placeholder="Opis pijanke (npr: nas 5 kod mene üî•)"></textarea>
            <button onclick="objaviPijanku()">Objavi</button>
        </div>
        <div id="profilKorisnika"></div>
    </div>

    <div class="container" id="privatniChat">
        <div class="top-nav-buttons">
            <button class="back-button" onclick="navigateBack()">‚Üê</button>
        </div>
    <div class="chat-header-info">
        <img id="chatPartnerSlika" src="default_profile.png" alt="Profilna slika" class="chat-partner-profilna">
        <h2 id="chatSaKorisnikom"></h2>
        <p id="chatPartnerStatus" class="status-text"></p>
    </div>
        <div id="privatniChatLog" class="chat"></div>
        <div class="chat-input-area">
            <div class="image-upload-icon">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="currentColor" stroke="none">
                    <path d="M8.5 13.5l-3.5 4.5h11l-4-6-3.5 4z"/>
                    <circle cx="9" cy="8" r="2.5"/>
                    <path d="M21 21H3a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h18a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2zM3 5v14h18V5H3z"/>
                </svg>
            </div>
            
            <textarea id="privatniInput" placeholder="Poruka..." rows="1"></textarea>
            
            <button id="posaljiPrivatnoBtn" onclick="posaljiPrivatno()" disabled>
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
                    <path d="M3.478 2.405a.75.75 0 00-.926.94l2.432 7.905H13.5a.75.75 0 010 1.5H4.984l-2.432 7.905a.75.75 0 00.926.94 60.519 60.519 0 0018.445-8.986.75.75 0 000-1.218A60.517 60.517 0 003.478 2.405z" />
                </svg>
            </button>
        </div>
    </div>
    
    <div class="container" id="editProfil">
        <div class="top-nav-buttons">
            <button class="back-button" onclick="navigateBack()">‚Üê</button>
        </div>
        <h2>Uredi profil</h2>
        <div style="text-align:center;">
            <img id="previewEditSlike" class="profilna-slika" />
        </div>
        <input id="editIme" placeholder="Korisniƒçko ime" />
        <textarea id="editOpis" placeholder="O meni..." rows="3"></textarea>
        <input id="editInstagram" placeholder="Instagram korisniƒçko ime" />
        <input id="editTiktok" placeholder="TikTok korisniƒçko ime" />
        <label style="font-size:14px; display:block; margin-bottom:5px;">Promijeni profilnu sliku:</label>
        <input type="file" id="editSlikaUpload" accept="image/*" />
        <button id="sacuvajProfilBtn" onclick="sacuvajProfil()">Spremi promjene</button>
    </div>

    <button id="fabObjaviPijanku" class="fab hidden-initially" onclick="pokaziObjavu()">
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="3" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" d="M12 4.5v15m7.5-7.5h-15" />
        </svg>
    </button>

    <nav class="bottom-nav hidden-initially">
        <button class="nav-button active" id="navHome" onclick="handleNavClick('homePrazan');">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" d="M2.25 12l8.954-8.955c.44-.439 1.152-.439 1.591 0L21.75 12M4.5 9.75v10.125c0 .621.504 1.125 1.125 1.125H9.75v-4.875c0-.621.504-1.125 1.125-1.125h2.25c.621 0 1.125.504 1.125 1.125v4.875h4.125c.621 0 1.125-.504 1.125-1.125V9.75M8.25 21.75h7.5" />
            </svg>
            <span>Home</span>
        </button>
        <button class="nav-button" id="navSearch" onclick="handleNavClick('lokacijePrikaz');">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" d="M21 21l-5.197-5.197m0 0A7.5 7.5 0 105.196 5.196a7.5 7.5 0 0010.607 10.607z" />
            </svg>
            <span>Tra≈æilica</span>
        </button>
        <button class="nav-button" id="navInbox" onclick="handleNavClick('inboxPrikaz');">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" d="M6 12L3.269 3.126A59.768 59.768 0 0121.485 12 59.77 59.77 0 013.27 20.876L5.999 12zm0 0h7.5" />
            </svg>
            <span>Inbox</span>
            <span id="notifikacijaPorukaGlavna" class="notification-badge-main"></span>
        </button>
        <button class="nav-button" id="navProfile" onclick="handleNavClick('profile');"> <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" d="M17.982 18.725A7.488 7.488 0 0012 15.75a7.488 7.488 0 00-5.982 2.975m11.963 0a9 9 0 10-11.963 0m11.963 0A8.966 8.966 0 0112 21a8.966 8.966 0 01-5.982-2.275M15 9.75a3 3 0 11-6 0 3 3 0 016 0z" />
            </svg>
            <span>Profil</span>
        </button>
    </nav>

    <script src="/script.js"></script>
    <script>
        // Pomoƒána funkcija za a≈æuriranje aktivnog gumba u navigaciji
        function updateActiveNavButton(activeButtonId) {
            document.querySelectorAll('.bottom-nav .nav-button').forEach(button => {
                button.classList.remove('active');
            });
            const activeButton = document.getElementById(activeButtonId);
            if (activeButton) {
                activeButton.classList.add('active');
            }
        }

        // Pomoƒána funkcija za kontrolu vidljivosti navigacije i FAB gumba
        function toggleAppUI(show) {
            const bottomNav = document.querySelector('.bottom-nav');
            const fabButton = document.getElementById('fabObjaviPijanku');

            if (bottomNav) {
                bottomNav.classList.toggle('hidden-initially', !show);
                bottomNav.style.pointerEvents = show ? 'auto' : 'none'; 
            }
            if (fabButton) {
                if(show) {
                    fabButton.classList.remove('hidden-initially');
                } else {
                    fabButton.classList.add('hidden-initially');
                }
                fabButton.style.pointerEvents = show ? 'auto' : 'none';
            }
        }

        // Glavna funkcija za rukovanje klikovima na navigacijske gumbe
        function handleNavClick(navTarget) { // navTarget mo≈æe biti screenId ili posebna akcija
            const currentActiveNavButton = document.querySelector('.bottom-nav .nav-button.active');
            let currentScreenId = document.querySelector('.container.active-screen')?.id;

            // Logika za sprjeƒçavanje ponovnog klika na isti gumb
            if (navTarget === 'homePrazan' && currentActiveNavButton?.id === 'navHome') return;
            if (navTarget === 'lokacijePrikaz' && currentActiveNavButton?.id === 'navSearch') return;
            if (navTarget === 'inboxPrikaz' && currentActiveNavButton?.id === 'navInbox') return;
            // Posebna provjera za profil (mo≈æe biti glavniDio ili editProfil)
            if (navTarget === 'profile') {
                if (currentActiveNavButton?.id === 'navProfile') {
                    // Ako je veƒá na profilu, ali na podstranici (npr. editProfil), vrati na glavni profil
                    if (currentScreenId === 'editProfil' || (currentScreenId === 'glavniDio' && document.getElementById("objavaForma").style.display !== "none")) {
                         prikaziMojProfil(); // Ponovno uƒçitaj moj profil
                         return;
                    }
                    // Ako je veƒá na glavnom profilu, ne radi ni≈°ta
                    if (currentScreenId === 'glavniDio' && document.getElementById("profilKorisnika").style.display !== "none") {
                         return;
                    }
                }
            }
            
            // Izvr≈°i navigaciju ili akciju
            if (navTarget === 'homePrazan') {
                navigateTo('homePrazan');
            } else if (navTarget === 'lokacijePrikaz') { 
                navigateTo('lokacijePrikaz');
            } else if (navTarget === 'inboxPrikaz') {
                otvoriInbox(); 
            } else if (navTarget === 'profile') { // Sada 'profile' je akcija za otvaranje vlastitog profila
                prikaziMojProfil(); 
            }
        }

        // Modificiramo DOMContentLoaded da se aplikacija odmah pokrene
        window.addEventListener('DOMContentLoaded', async function() {
            localStorage.removeItem("loggedInUserId"); 
            const token = localStorage.getItem("token");

            document.querySelectorAll('.container').forEach(el => {
                el.style.display = 'none';
                el.classList.remove('active-screen', 'fade-out-screen');
            });

            let appInitializedSuccessfully = false;
            if (token) {
                try {
                    const response = await authenticatedFetch('/api/auth/me');
                    if (response.ok) {
                        const data = await response.json();
                        trenutniKorisnik = data.user;
                        await Promise.all([ dohvatiSveKorisnike(), dohvatiSvePijanke() ]); 
                        appInitializedSuccessfully = true;
                    } else {
                        localStorage.removeItem("token");
                    }
                } catch (error) {
                    localStorage.removeItem("token");
                }
            }

            if (appInitializedSuccessfully) {
                pokreniAplikaciju();
            } else {
                navigateTo('intro'); 
                toggleAppUI(false); 
            }

            const privatniInput = document.getElementById('privatniInput');
            const posaljiBtn = document.getElementById('posaljiPrivatnoBtn');
            
            if (privatniInput && posaljiBtn) {
                privatniInput.addEventListener('input', () => {
                    privatniInput.style.height = 'auto';
                    privatniInput.style.height = `${privatniInput.scrollHeight}px`;
                    if (privatniInput.value.trim().length > 0) {
                        posaljiBtn.disabled = false;
                        posaljiBtn.classList.add('enabled');
                    } else {
                        posaljiBtn.disabled = true;
                        posaljiBtn.classList.remove('enabled');
                    }
                });
            }
        });

        // Modificiramo pokreniAplikaciju da prika≈æe UI i postavi aktivni gumb
        const originalPokreniAplikaciju = pokreniAplikaciju;
        pokreniAplikaciju = function() {
            originalPokreniAplikaciju(); 
            toggleAppUI(true); 
            navigateTo('homePrazan'); 
        };

        // Modificiramo odjaviSe da sakrije UI
        const originalOdjaviSe = odjaviSe;
        odjaviSe = function() {
            originalOdjaviSe();
            toggleAppUI(false); 
        };
        
        // Funkcija koja se poziva nakon ≈°to se swap zavr≈°i, da a≈æurira aktivni nav gumb
        function afterSwapUpdateNavButton(targetScreenId) {
            const fabButton = document.getElementById('fabObjaviPijanku');
            if (fabButton) {
                fabButton.style.display = (targetScreenId === 'lokacijePrikaz' || targetScreenId === 'homePrazan') ? 'flex' : 'none';
            }

            if (targetScreenId === 'homePrazan') {
                updateActiveNavButton('navHome');
            } else if (targetScreenId === 'lokacijePrikaz') { 
                updateActiveNavButton('navSearch');
                prikaziPijankePregled(); 
            } else if (targetScreenId === 'inboxPrikaz') {
                updateActiveNavButton('navInbox');
            } else if (targetScreenId === 'glavniDio' || targetScreenId === 'editProfil') { // Oboje spadaju pod profil nav gumb
                updateActiveNavButton('navProfile');
            }
            else if (targetScreenId === 'privatniChat' || targetScreenId === 'objavaForma') { // Ekran bez aktivnog nav gumba
                document.querySelectorAll('.bottom-nav .nav-button').forEach(button => {
                    button.classList.remove('active');
                });
            }
            else {
                // Za ostale ekrane (intro, login, registracija, pravilaEkran), ukloni active
                document.querySelectorAll('.bottom-nav .nav-button').forEach(button => {
                    button.classList.remove('active');
                });
            }
        }

        // Modificiramo navigateTo
        const originalNavigateTo = navigateTo;
        navigateTo = function(targetScreenId) {
            const currentScreenEl = document.querySelector('.container.active-screen');
            
            const navBarRootScreens = ['homePrazan', 'lokacijePrikaz', 'inboxPrikaz', 'glavniDio']; // Glavni ekrani navigacije
            const isTargetANavBarRoot = navBarRootScreens.includes(targetScreenId);
            const isCurrentANavBarRoot = currentScreenEl && navBarRootScreens.includes(currentScreenEl.id);

            // Logic for push/pop on navigationStack
            if (currentScreenEl && !isTargetANavBarRoot && currentScreenEl.id !== 'splashScreen') {
                // Only push if not navigating FROM a root nav screen TO another root nav screen,
                // and not already on the target screen in the stack (to prevent duplicates)
                if (!navigationStack.includes(currentScreenEl.id) && currentScreenEl.id !== targetScreenId) {
                    navigationStack.push(currentScreenEl.id);
                }
            }
            // Special case for editing profile (editProfil) returning to main profile (glavniDio)
            if (currentScreenEl?.id === 'editProfil' && targetScreenId === 'glavniDio') {
                 // Do not push 'editProfil' onto stack if just coming back from it to its parent profile
                 if (navigationStack[navigationStack.length - 1] === 'editProfil') {
                     navigationStack.pop();
                 }
            } else if (currentScreenEl?.id === 'glavniDio' && document.getElementById("objavaForma").style.display !== "none" && targetScreenId === 'glavniDio') {
                // If submitting a post, and navigating back to glavnIDio (profile view) do not push
            }


            swap(currentScreenEl ? currentScreenEl.id : null, targetScreenId);
            afterSwapUpdateNavButton(targetScreenId);
        };

        // Modificiramo navigateBack
        const originalNavigateBack = navigateBack;
        navigateBack = function() {
            const currentScreenEl = document.querySelector('.container.active-screen');
            if (currentScreenEl && currentScreenEl.id === 'privatniChat') {
                if (chatStatusInterval) clearInterval(chatStatusInterval);
                trenutniChatPartnerId = null;
                const privatniInput = document.getElementById("privatniInput");
                privatniInput.value = "";
                privatniInput.style.height = 'auto';
                document.getElementById('posaljiPrivatnoBtn').classList.remove('enabled');
            }

            const lastScreenId = navigationStack.pop();
            if (lastScreenId) {
                 swap(currentScreenEl.id, lastScreenId);
                 azurirajNotifikacije();
                 setTimeout(() => {
                     const newActiveScreenEl = document.querySelector('.container.active-screen');
                     if (newActiveScreenEl) {
                         afterSwapUpdateNavButton(newActiveScreenEl.id);
                     } else {
                         document.querySelectorAll('.bottom-nav .nav-button').forEach(button => {
                             button.classList.remove('active');
                         });
                     }
                 }, 300); 
            } else {
                 console.error("Navigation stack empty, can't go back.");
                 // Ako je stack prazan, a back je pozvan (npr. na glavnom ekranu),
                 // mo≈æemo se vratiti na 'homePrazan' kao fallback.
                 navigateTo('homePrazan');
            }
        };

        // Kada se otvara profil
        const originalOtvoriProfil = otvoriProfil;
        otvoriProfil = function(korisnikId) {
            // Nemoj zvati navigateTo ovdje direktno jer handleNavClick to veƒá radi.
            // Ova funkcija treba samo postaviti sadr≈æaj profila unutar 'glavniDio'
            // i pobrinuti se za prika≈æivanje/skrivanje gumba za nazad.

            const korisnik = sviKorisnici.find(u => u.id === korisnikId);
            if (!korisnik) return;
            
            const profilKorisnikaDiv = document.getElementById("profilKorisnika");
            const objavaFormaDiv = document.getElementById("objavaForma");

            objavaFormaDiv.style.display = "none"; // Sakrij formu za objavu
            profilKorisnikaDiv.style.display = "flex"; // Prika≈æi profil div
            
            let actionButtons = '';
            if (trenutniKorisnik && korisnik.id === trenutniKorisnik.id) {
                document.querySelector('#glavniNaslov').innerText = "Moj profil"; 
                actionButtons = `<button onclick="prikaziEditProfila()">Uredi profil</button><button class="btn-danger" onclick="odjaviSe()">Odjavi se</button>`;
            } else {
                document.querySelector('#glavniNaslov').innerText = "Profil korisnika"; 
                actionButtons = `<button onclick="pokreniPrivatniChat('${korisnik.id}')">üí¨ Po≈°alji poruku</button>`;
            }

            profilKorisnikaDiv.innerHTML = `
                <img src="${korisnik.slika || 'default_profile.png'}" class="profilna-slika-velika">
                <h2 style="padding-top:0; margin-bottom: 5px;">${korisnik.ime || 'Nepoznat korisnik'}</h2>
                <p class="profil-opis">${korisnik.opis || "Nema opisa."}</p>
                <div class="drustvene-mreze">${prikaziMreze(korisnik)}</div>
                <div class="profil-actions">${actionButtons}</div>
            `;

            // Prikaz back/close gumba samo ako nije glavni profil (za povratak s tuƒëeg profila)
            const backButtonGlavniDio = document.querySelector('#glavniDio .back-button');
            const closeButtonGlavniDio = document.querySelector('#glavniDio .close-btn');

            if (trenutniKorisnik && korisnik.id === trenutniKorisnik.id) {
                // Ako je vlastiti profil, back/close gumbi nisu relevantni
                backButtonGlavniDio.style.display = 'none';
                closeButtonGlavniDio.style.display = 'none';
            } else {
                // Ako je tuƒëi profil, prika≈æi back gumb
                backButtonGlavniDio.style.display = 'flex';
                closeButtonGlavniDio.style.display = 'none';
            }
            // afterSwapUpdateNavButton se poziva iz handleNavClick / navigateTo
        };

        // Kada se otvara inbox
        const originalOtvoriInbox = otvoriInbox;
        otvoriInbox = function() {
            // Ne pozivamo navigateTo direktno, nego ga handleNavClick poziva
            
            const div = document.getElementById("listaChatova");
            div.innerHTML = ""; 
            div.innerHTML = '<p style="text-align:center;color:#888;">Uƒçitavanje poruka...</p>'; 

            dohvatiSvePoruke().then(() => {
                const chatKeys = (trenutniKorisnik && trenutniKorisnik.id) ? Object.keys(privatnePoruke).filter(key => key.includes(trenutniKorisnik.id)) : [];
                if (chatKeys.length === 0) {
                    div.innerHTML = '<p style="text-align:center;color:#888;">Nema≈° jo≈° nijednu poruku.</p>';
                } else {
                    div.innerHTML = ""; 
                    chatKeys.sort((a, b) => new Date(privatnePoruke[b].slice(-1)[0]?.time) - new Date(privatnePoruke[a].slice(-1)[0]?.time))
                    .forEach(chatKey => {
                        const partnerId = chatKey.split("-").find(id => id !== trenutniKorisnik.id);
                        const partner = sviKorisnici.find(u => u.id == partnerId);
                        if (!partner) return;
                        const neprocitane = privatnePoruke[chatKey].some(m => !m.isRead && m.autorId == partner.id);
                        const status = formatirajStatus(partner.lastActive);
                        div.innerHTML += `
                            <div class="chat-item" onclick="pokreniPrivatniChat('${partner.id}')">
                                <img src="${partner.slika || 'default_profile.png'}" alt="profilna">
                                <div class="chat-item-info">
                                    <span class="status-dot ${status.online ? "online" : "offline"}"></span>
                                    <div class="chat-item-info-text">
                                        <strong>${partner.ime}</strong>
                                        <p class="status-text">${status.online ? "Online" : status.text}</p>
                                    </div>
                                </div>
                                ${neprocitane ? '<span class="notification-badge-chat"></span>' : ""}
                            </div>`;
                    });
                }
                azurirajNotifikacije(); 
            }).catch(error => {
                div.innerHTML = '<p style="text-align:center;color:#888;">Gre≈°ka pri uƒçitavanju poruka.</p>';
                console.error("Gre≈°ka pri dohvaƒáanju poruka:", error);
            });
        };


        // Kada se poka≈æe objava
        const originalPokaziObjavu = pokaziObjavu;
        pokaziObjavu = function() {
            // handleNavClick ƒáe pozvati navigateTo('glavniDio') za objavu forme
            // Ova funkcija treba samo postaviti display za objavaForma
            document.querySelector('#glavniNaslov').innerText = "Objavi pijanku";
            document.getElementById("objavaForma").style.display = "flex";
            document.getElementById("profilKorisnika").style.display = "none";
            document.getElementById("opisPijanke").value = "";
            document.querySelector('#glavniDio .back-button').style.display = 'none';
            document.querySelector('#glavniDio .close-btn').style.display = 'flex';
            // afterSwapUpdateNavButton se poziva iz navigateTo
        };

    </script>
</body>
</html>